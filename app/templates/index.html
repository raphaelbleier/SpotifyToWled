{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Control Panel -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-gear-fill"></i> Control Panel
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if is_running %}
                        <button onclick="stopSync()" class="btn btn-danger btn-lg">
                            <i class="bi bi-stop-circle"></i> Stop Sync
                        </button>
                    {% else %}
                        <button onclick="startSync()" class="btn btn-success btn-lg">
                            <i class="bi bi-play-circle"></i> Start Sync
                        </button>
                    {% endif %}
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <label class="form-label">Color Extraction Method</label>
                    <select class="form-select" id="colorMethod" onchange="updateColorMethod(this.value)">
                        <option value="vibrant" {{ 'selected' if color_method == 'vibrant' else '' }}>Vibrant (Recommended)</option>
                        <option value="dominant" {{ 'selected' if color_method == 'dominant' else '' }}>Dominant</option>
                        <option value="average" {{ 'selected' if color_method == 'average' else '' }}>Average</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Current Color Display -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <i class="bi bi-palette-fill"></i> Current Color
            </div>
            <div class="card-body text-center">
                <div id="colorDisplay" class="color-preview mx-auto mb-3" 
                     style="background-color: {{ current_color_hex }};">
                </div>
                <div id="colorRGB" class="color-info">
                    RGB: ({{ current_color[0] }}, {{ current_color[1] }}, {{ current_color[2] }})
                </div>
                <div id="colorHex" class="color-info text-muted">
                    {{ current_color_hex }}
                </div>
            </div>
        </div>
    </div>

    <!-- Now Playing -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="bi bi-spotify"></i> Now Playing
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        {% if current_album_image_url %}
                            <img id="albumCover" src="{{ current_album_image_url }}" 
                                 class="img-fluid rounded shadow-sm" alt="Album Cover">
                        {% else %}
                            <div class="album-placeholder d-flex align-items-center justify-content-center">
                                <i class="bi bi-music-note-beamed display-1 text-muted"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-8">
                        <div id="trackInfo">
                            {% if current_track %}
                                <h4 id="trackName" class="mb-2">{{ current_track.name }}</h4>
                                <p id="trackArtist" class="text-muted mb-1">
                                    <i class="bi bi-person"></i> {{ current_track.artist }}
                                </p>
                                <p id="trackAlbum" class="text-muted">
                                    <i class="bi bi-disc"></i> {{ current_track.album }}
                                </p>
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-music-note display-1"></i>
                                    <p class="mt-3">No track playing</p>
                                    <small>Start playing music on Spotify</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Color History -->
        <div class="card mt-3">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-clock-history"></i> Color History
            </div>
            <div class="card-body">
                <div id="colorHistory" class="color-history">
                    {% if color_history %}
                        {% for item in color_history %}
                            <div class="color-history-item" title="{{ item.track }} - {{ item.artist }}">
                                <div class="color-history-box" 
                                     style="background-color: rgb({{ item.color[0] }}, {{ item.color[1] }}, {{ item.color[2] }});">
                                </div>
                                <small class="color-history-label">{{ item.track[:20] }}...</small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">No color history yet</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Section -->
<div class="row mt-4">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-key-fill"></i> Spotify Configuration
            </div>
            <div class="card-body">
                <form action="/api/config/update" method="post">
                    <div class="mb-3">
                        <label class="form-label">Client ID</label>
                        <input type="text" name="client_id" class="form-control" 
                               value="{{ spotify_client_id }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Client Secret</label>
                        <input type="password" name="client_secret" class="form-control" 
                               value="{{ spotify_client_secret }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Refresh Interval (seconds)</label>
                        <input type="number" name="refresh_interval" class="form-control" 
                               value="{{ refresh_interval }}" min="1" required>
                    </div>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-save"></i> Save Configuration
                    </button>
                </form>
                
                {% if not spotify_authenticated and spotify_client_id and spotify_client_secret %}
                <hr>
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i> You need to authorize this app with Spotify
                </div>
                <button onclick="authenticateSpotify()" class="btn btn-success w-100">
                    <i class="bi bi-spotify"></i> Authenticate with Spotify
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-lightbulb-fill"></i> WLED Devices
            </div>
            <div class="card-body">
                <div id="wledDevices" class="mb-3">
                    {% if wled_ips %}
                        {% for ip in wled_ips %}
                            <div class="wled-device-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                <div>
                                    <i class="bi bi-lightbulb"></i>
                                    <span class="ms-2">{{ ip }}</span>
                                </div>
                                <div>
                                    <button onclick="checkWledHealth('{{ ip }}')" 
                                            class="btn btn-sm btn-outline-info me-1" title="Check Status">
                                        <i class="bi bi-activity"></i>
                                    </button>
                                    <button onclick="removeWled('{{ ip }}')" 
                                            class="btn btn-sm btn-outline-danger" title="Remove">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No WLED devices configured</p>
                    {% endif %}
                </div>
                
                <form action="/api/wled/add" method="post" class="mt-3">
                    <div class="input-group">
                        <input type="text" name="ip" class="form-control" 
                               placeholder="192.168.x.x" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-plus-circle"></i> Add Device
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Health Status -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-heart-pulse"></i> System Health
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="health-metric">
                            <i class="bi bi-spotify display-4 text-success"></i>
                            <p class="mt-2">Spotify</p>
                            <span class="badge {{ 'bg-success' if spotify_authenticated else 'bg-danger' }}">
                                {{ 'Connected' if spotify_authenticated else 'Disconnected' }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="health-metric">
                            <i class="bi bi-lightbulb display-4 text-danger"></i>
                            <p class="mt-2">WLED Devices</p>
                            <span class="badge bg-info">{{ wled_ips|length }} Configured</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="health-metric">
                            <i class="bi bi-clock display-4 text-primary"></i>
                            <p class="mt-2">Refresh Rate</p>
                            <span class="badge bg-primary">{{ refresh_interval }}s</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="health-metric">
                            <i class="bi bi-palette display-4 text-warning"></i>
                            <p class="mt-2">Colors Synced</p>
                            <span class="badge bg-warning">{{ color_history|length }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh every 5 seconds when running
    {% if is_running %}
    setInterval(() => {
        updateStatus();
    }, 5000);
    {% endif %}
</script>
{% endblock %}
